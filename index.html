<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tuumat ja Millit 1.2</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f3f4f6;
    }

    .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }

    h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
        text-align: center;
    }

    a {
        display: block;
        text-align: center;
        margin-bottom: 15px;
        color: #2563eb;
        font-size: 18px;
        word-break: break-all;
        text-decoration: none;
    }

    p {
        font-size: 18px;
        line-height: 1.4;
        color: #444;
        text-align: center;
    }

    input {
        width: 100%;
        padding: 14px;
        font-size: 18px;
        border: 2px solid #ccc;
        border-radius: 8px;
        margin-top: 15px;
        box-sizing: border-box;
    }

    input:focus {
        outline: none;
        border-color: #2563eb;
    }

    button {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 12px;
    }

    button:hover {
        background: #1e4fc7;
    }

    #results {
        margin-top: 20px;
        white-space: pre-line;
        font-family: monospace;
        font-size: 18px;
        padding: 15px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        min-height: 40px;
    }

    #toggleBtn {
        background: #111827;
    }
    #toggleBtn:hover {
        background: #0b1220;
    }

</style>
</head>
<body>

<div class="container">
    <a href="https://www.youtube.com/@torala" target="_blank">www.youtube.com/@torala</a>

    <h1>Tuuma-milli muunnin</h1>

    <p>Voit syöttää tuumat murtolukuina, sekalukuina, tai desimaaleina</p>
    <button id="toggleBtn" type="button" onclick="toggleMode()">Tuumat milleiksi</button>

    <div id="inchFormatRow" style="margin-top:10px; display:none;">
     <label style="display:block; font-size:16px; margin-bottom:6px;">Näytä tuumat muodossa</label>
     <select id="inchFormat" style="width:100%; padding:12px; font-size:18px; border:2px solid #ccc; border-radius:8px; box-sizing:border-box;">
    <option value="dec" selected>Dec</option>
    <option value="frac16">/16</option>
    <option value="frac32">/32</option>
    <option value="frac64">/64</option>
    <option value="frac128">/128</option>
    <option value="pipe">Putkikierre</option>
  </select>
</div>

    <input id="inputField" type="text" inputmode="decimal" placeholder="Syötä tuumat">
    <button id="convertBtn" type="button" onclick="convert()">Muunna</button>
    <button id="copyBtn" onclick="copyLast()" style="margin-top:10px;">Kopioi viimeisin</button>


    <div id="results"></div>
</div>

<script>
document.getElementById("inputField").addEventListener("keydown", function(e) {
    if (e.key === "Enter") convert();
});

let results = [];

let mode = "in_to_mm"; // tai "mm_to_in"
let lastConvertedValue = ""; // tämä on se arvo, joka kopioidaan (vain numero, pilkulla)

function toggleMode() {
    mode = (mode === "in_to_mm") ? "mm_to_in" : "in_to_mm";

    const toggleBtn = document.getElementById("toggleBtn");
    const inputField = document.getElementById("inputField");

    if (mode === "in_to_mm") {
        toggleBtn.innerText = "Tuumat milleiksi";
        inputField.placeholder = "Syötä tuumat";
    } else {
        toggleBtn.innerText = "Millit tuumiksi";
        inputField.placeholder = "Syötä millimetrit";
    }

    inputField.focus();

    document.getElementById("inchFormatRow").style.display =
        (mode === "mm_to_in") ? "block" : "none";
}

function gcd(a, b) {
    a = Math.abs(a); b = Math.abs(b);
    while (b) { const t = b; b = a % b; a = t; }
    return a || 1;
}

function roundInchesToDen(inches, maxDen) {
    const sign = inches < 0 ? -1 : 1;
    inches = Math.abs(inches);

    let whole = Math.floor(inches);
    let frac = inches - whole;

    let num = Math.round(frac * maxDen);
    let den = maxDen;

    if (num === den) { // ylivuoto kokonaiseksi
        whole += 1;
        num = 0;
    }

    // yksinkertaistus ei ole pakollinen lukuarvolle, mutta ok
    const g = gcd(num, den);
    num /= g; den /= g;

    return sign * (whole + (num / den));
}

// Muuntaa desimaalituumat lähimpään murtolukuun annetulla max-nimittäjällä (16/32/64/128)
// Palauttaa muodossa: 1 1/2, 3/8, 2 (ilman ylimääräisiä 0/1 tms.)
function inchesToFractionString(inches, maxDen) {
    const sign = inches < 0 ? "-" : "";
    inches = Math.abs(inches);

    let whole = Math.floor(inches);
    let frac = inches - whole;

    // Pyöristetään lähimpään 1/maxDen
    let num = Math.round(frac * maxDen);
    let den = maxDen;

    // Jos pyöristys menee tasan seuraavaan kokonaislukuun
    if (num === den) {
        whole += 1;
        num = 0;
    }

    // Jos ei murtosaa
    if (num === 0) {
        return sign + String(whole);
    }

    // Yksinkertaistus (tämä takaa 0.5 => 1/2 eikä 64/128)
    const g = gcd(num, den);
    num = num / g;
    den = den / g;

    if (whole === 0) return `${sign}${num}/${den}`;
    return `${sign}${whole} ${num}/${den}`;
}

function getMaxDenFromSelect() {
    const v = document.getElementById("inchFormat").value;
    if (v === "pipe") return "pipe";
    if (v === "frac16") return 16;
    if (v === "frac32") return 32;
    if (v === "frac64") return 64;
    if (v === "frac128") return 128;
    return null; // desimaali
}

function fmt3(x) { return x.toFixed(3).replace(".", ","); }

// G-putkikierteen nimelliskoot ja niitä vastaavat ulkohalkaisijat (mm).
const PIPE_SIZES = [
  { size: '1/8',   od:  9.728 },
  { size: '1/4',   od: 13.157 },
  { size: '3/8',   od: 16.662 },
  { size: '1/2',   od: 20.955 },
  { size: '3/4',   od: 26.441 },
  { size: '1',     od: 33.249 },
  { size: '1 1/4', od: 41.910 },
  { size: '1 1/2', od: 47.803 },
  { size: '2',     od: 59.614 },
  { size: '2 1/2', od: 75.184 },
  { size: '3',     od: 87.884 },
  { size: '4',     od: 113.030 }
];


function nearestPipeSize(odMm) {
    let best = PIPE_SIZES[0];
    let bestAbs = Math.abs(odMm - best.od);

    for (const it of PIPE_SIZES) {
        const d = Math.abs(odMm - it.od);
        if (d < bestAbs) {
            bestAbs = d;
            best = it;
        }
    }
    return {
        size: best.size,
        approxOd: best.od,
        diff: best.od - odMm
    };
}

function convert() {
    const inputField = document.getElementById("inputField");
    const input = inputField.value.trim();
    const original = input;

    if (input === "") return;

    if (mode === "in_to_mm") {
        let inches = null;

        // Murtoluku X/Y
        let fraction = input.match(/^(\d+)\/(\d+)$/);
        if (fraction) {
            inches = parseFloat(fraction[1]) / parseFloat(fraction[2]);
        }

        // Desimaali (myös pilkulla)
        if (inches === null) {
            let decimal = input.replace(",", ".");
            if (/^\d*[.]?\d+$/.test(decimal)) {
                inches = parseFloat(decimal);
            }
        }

        // Sekaluku X Y/Z
        if (inches === null) {
            let mixed = input.match(/^(\d+)(?:\s+|-)(\d+)\/(\d+)$/);
            if (mixed) {
                inches = parseFloat(mixed[1]) + (parseFloat(mixed[2]) / parseFloat(mixed[3]));
            }
        }

    if (inches === null) {
            alert("Virheellinen syöte");
            return;
        }

        const mm = inches * 25.4;
        const mmText = mm.toFixed(3).replace(".", ",");  // näytetään pilkulla
        lastConvertedValue = mmText;                     // kopioidaan tämä

        const resultText = `${original}" = ${mmText} mm`;
        results.unshift(resultText);

    }
    else {
        // --- MM -> TUUMAT (desimaali pilkulla tai pisteellä) ---
const decimal = input.replace(",", ".");
if (!/^\d*[.]?\d+$/.test(decimal)) {
    alert("Virheellinen syöte");
    return;
}

const mm = parseFloat(decimal);
const inches = mm / 25.4;

const maxDen = getMaxDenFromSelect();

//let inchText;
if (maxDen === "pipe") {
    const p = nearestPipeSize(mm); // tarvitsee nearestPipeSize + fmt3 helperit

    const sign = p.diff >= 0 ? "+" : "-";
    const diffText = Math.abs(p.diff).toFixed(3).replace(".", ",");

    results.unshift(
        `${original} mm = G ${p.size} (Ø${p.approxOd.toFixed(3).replace(".", ",")} mm)`
    );

    lastConvertedValue = `G ${p.size}`;

} else if (maxDen === null) {
    // Desimaalit
    inchText = inches.toFixed(4);
    lastConvertedValue = inchText.replace(".", ",");
    results.unshift(`${original} mm = ${inchText}"`);
} else {
    // Murtoluku + pyöristyserotus millimetreinä
    const roundedInches = roundInchesToDen(inches, maxDen);
    const inchText = inchesToFractionString(roundedInches, maxDen);

    const roundedMm = roundedInches * 25.4;
    const diffMm = roundedMm - mm;  // pyöristetty − syöte

    const roundedMmText = roundedMm.toFixed(3).replace(".", ",");
    const diffText = diffMm.toFixed(3).replace(".", ",");

    // Muoto: (9,525 mm, −0,475 mm)
    results.unshift(
        `${original} mm = ${inchText}" (${roundedMmText} mm, ${diffText} mm)`
    );

    lastConvertedValue = inchText;
}
    }

    if (results.length > 10) results.pop();
    document.getElementById("results").innerText = results.join("\n");

    inputField.value = "";
}

function copyLast() {
    if (!lastConvertedValue) {
        alert("Ei kopioitavaa – tee ensin muunnos.");
        return;
    }

    navigator.clipboard.writeText(lastConvertedValue)
        .then(() => alert("Kopioitu leikepöydälle: " + lastConvertedValue))
        .catch(err => alert("Kopiointi epäonnistui: " + err));
}



</script>
</body>
</html>
